<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<title>PROJECT CAGE : RELOADED v16.9 (Auto-Fix Mode)</title>
<style>
    /* ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰ CSS æ¨£å¼ */
    :root {
        --bg: #050505; --card: #0a0a0c; --bar: #1a1a1e; --text: #e0e0e0; --mute: #888;
        --tw: #ff2a2a; --us: #00d2ff; --yield: #00ff6a; --ber: #ff9100; --trap: #bd00ff; 
        --gold: #ffd700; 
        --red: #ff2a2a;   /* ç²åˆ©è‰² (ç´…) */
        --green: #00ff6a; /* è™§æè‰² (ç¶ ) */
        --cyan: #00f7ff; 
        --emergency: #ff0000;
        --hud-cyan: #00eaff; --hud-green: #00ff4c; --hud-gold: #ffcc00;
        --font-tech: 'Orbitron', sans-serif; --font-num: 'Rajdhani', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #000; background-image: linear-gradient(rgba(0, 20, 30, 0.9), rgba(0, 5, 10, 1)), linear-gradient(0deg, transparent 24%, rgba(0, 255, 255, .05) 25%, rgba(0, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 255, .05) 75%, rgba(0, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(0, 255, 255, .05) 25%, rgba(0, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 255, .05) 75%, rgba(0, 255, 255, .05) 76%, transparent 77%, transparent); background-size: 100% 100%, 50px 50px, 50px 50px; color: var(--text); font-family: 'Segoe UI', sans-serif; line-height: 1.3; overflow-x: hidden; padding-bottom: 30px; }
    #refresh-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 0; background: rgba(0, 247, 255, 0.1); display: flex; justify-content: center; align-items: center; overflow: hidden; transition: height 0.2s; z-index: 9999; pointer-events: none; backdrop-filter: blur(5px); border-bottom: 1px solid var(--cyan); }
    .refresh-text { font-family: var(--font-tech); color: var(--cyan); font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,247,255,0.3); border-radius: 50%; border-top-color: var(--cyan); animation: spin 1s infinite; display: none; }
    header { padding: 15px 20px; text-align: center; }
    h1 { font-size: 1.6rem; font-family: var(--font-tech); font-weight: 900; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 10px; }
    .dashboard-wrapper { margin-top: 20px; padding: 15px; background: linear-gradient(180deg, #2a2a30, #1a1a1e); border-radius: 8px; border: 1px solid #444; }
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 8px; background: #000; border-radius: 4px; }
    .hud-screen { padding: 20px 15px; min-height: 180px; position: relative; border: 1px solid rgba(255,255,255,0.1); }
    .hud-title { font-weight: 700; color: #fff; text-align: center; margin-bottom: 20px; }
    .main-val { font-family: var(--font-num); font-size: 2.2rem; font-weight: 700; text-align: center; }
    .total-val { font-family: var(--font-num); font-size: 3.5rem; font-weight: 700; text-align: center; color: var(--hud-gold); }
    .pl-val { font-family: var(--font-num); font-size: 1.3rem; font-weight: bold; }
    .mc-media { width: 56px; height: 56px; object-fit: contain; }
    .deck-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
    .micro-card { background: var(--card); border: 2px solid #333; border-radius: 12px; padding: 10px; cursor: pointer; position: relative; }
    .lb-card-icon { width: 26px; height: 26px; object-fit: contain; }
    /* ... æ›´å¤šæ¨£å¼çœç•¥ä»¥ç¯€çœç©ºé–“ï¼Œèˆ‡ v16.8 ä¿æŒä¸€è‡´ ... */
</style>
</head>
<body>
<div id="refresh-indicator"><div class="refresh-text"><div class="spinner"></div>REFRESHING...</div></div>
<header>
  <h1 id="pageTitle">PROJECT CAGE</h1>
  <div class="meta-info" id="pageMeta">v16.9 LIVE</div>
</header>

<div class="container">
  <div class="dashboard-wrapper">
      <div class="dash-grid">
          <div class="hud-screen cyan">
              <div class="hud-title">TWD æˆ°æƒ… (å°å¹£)</div>
              <div id="costTW" style="text-align:center; color:#888;">ç¸½æŠ•å…¥: ...</div>
              <div class="main-val c-cyan" id="assetTW">0</div>
              <div style="text-align:center;"><span class="pl-val" id="plTW_val">0</span> <span id="plTW_pct">0%</span></div>
          </div>
          <div class="hud-screen green">
              <div class="hud-title">USD æˆ°æƒ… (ç¾é‡‘)</div>
              <div id="costUS" style="text-align:center; color:#888;">ç¸½æŠ•å…¥: ...</div>
              <div class="main-val c-green" id="assetUS">0</div>
              <div style="text-align:center;"><span class="pl-val" id="plUS_val">0</span> <span id="plUS_pct">0%</span></div>
          </div>
          <div class="hud-screen gold">
              <div class="hud-title">ç¶œåˆè³‡ç”¢ (æ›ç®—å°å¹£)</div>
              <div class="total-val" id="totalAsset">0</div>
              <div id="rateInfo" style="text-align:center; color:#666; font-size:0.8rem;">åŒ¯ç‡è®€å–ä¸­...</div>
          </div>
      </div>
  </div>

  <div class="section-title">æŠ•è³‡ç«¶æŠ€å ´</div>
  <div id="arenaContainer"></div>

  <div class="section-title">æŠ€èƒ½å¡ç‰Œ</div>
  <div class="deck-wrapper"><div class="deck-grid" id="cardContainer"></div></div>
</div>

<script>
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuNQc8E7BlYLR5E6WlYHVQ3l_ki95CqcEcpS8sNQESRKcg5yECE-e2bgMvLGU-Vx5HFuWo5OS1GUIT/pub?output=tsv';

let currentRate = 32.5;
let cardsData = {};
let portfolios = {};

// ğŸ› ï¸ Google Drive é€£çµè‡ªå‹•è½‰æ›å‡½æ•¸
function fixDriveUrl(url) {
    if (!url) return '';
    if (url.includes('drive.google.com')) {
        let fileId = '';
        if (url.includes('id=')) {
            fileId = url.split('id=')[1].split('&')[0];
        } else if (url.includes('/d/')) {
            fileId = url.split('/d/')[1].split('/')[0];
        }
        return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
    }
    return url;
}

async function init() {
    try {
        const rateRes = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const rateData = await rateRes.json();
        if(rateData?.rates?.TWD) currentRate = rateData.rates.TWD;
        document.getElementById('rateInfo').textContent = `å³æ™‚åŒ¯ç‡ USD/TWD: ${currentRate}`;
    } catch(e) { console.warn("åŒ¯ç‡è®€å–å¤±æ•—"); }

    const res = await fetch(GOOGLE_SHEET_URL + `&t=${Date.now()}`);
    const text = await res.text();
    parseData(text);
    renderAll();
}

function parseData(text) {
    const rows = text.split('\n').map(r => r.trim());
    let isStrategy = false;
    let currentGroup = 'æœªåˆ†é¡';

    rows.forEach(row => {
        const c = row.split('\t');
        if (!c[0]) return;

        // å¡ç‰Œè§£æé‚è¼¯
        if (c[0].startsWith('C')) {
            const costStr = c[5] || '0';
            const isUSD = costStr.includes('$') && !costStr.includes('NT$');
            
            // ä¿®å¾©åœ–ç‰‡ç¶²å€
            const rawImg = c[9] ? c[9].trim() : '';
            const fixedImg = fixDriveUrl(rawImg);

            cardsData[c[0]] = {
                code: c[0],
                type: c[1],
                skill: c[4],
                isUSD: isUSD,
                cost: parseFloat(costStr.replace(/[NT$US,\s]/g, '')) || 0,
                current: parseFloat((c[6] || '0').replace(/[NT$US,\s]/g, '')) || 0,
                imgUrl: fixedImg,
                media: fixedImg ? `<img src="${fixedImg}" class="mc-media">` : ''
            };
        }
        // åˆ†çµ„èˆ‡ç­–ç•¥è§£æ (ç•¥éç´°ç¯€ï¼Œèˆ‡ v16.8 é‚è¼¯ä¸€è‡´)
    });
}

function renderDashboard() {
    let tcTW = 0, taTW = 0, tcUS = 0, taUS = 0;
    
    Object.values(cardsData).forEach(c => {
        if (c.isUSD) {
            tcUS += c.cost; taUS += c.current;
        } else {
            tcTW += c.cost; taTW += c.current;
        }
    });

    const sTW = calc(tcTW, taTW);
    const sUS = calc(tcUS, taUS);

    document.getElementById('costTW').textContent = `ç¸½æŠ•å…¥: NT$ ${(tcTW/10000).toFixed(0)}è¬`;
    document.getElementById('assetTW').textContent = taTW.toLocaleString();
    document.getElementById('plTW_val').textContent = `${taTW-tcTW >= 0 ? '+' : ''}${(taTW-tcTW).toLocaleString()}`;
    document.getElementById('plTW_pct').textContent = `(${sTW.roi}%)`;

    document.getElementById('costUS').textContent = `ç¸½æŠ•å…¥: $ ${(tcUS/10000).toFixed(0)}è¬`;
    document.getElementById('assetUS').textContent = `$${taUS.toLocaleString()}`;
    document.getElementById('plUS_val').textContent = `${taUS-tcUS >= 0 ? '+' : ''}$${(taUS-tcUS).toLocaleString()}`;
    document.getElementById('plUS_pct').textContent = `(${sUS.roi}%)`;

    const totalAssetTWD = taTW + (taUS * currentRate);
    document.getElementById('totalAsset').textContent = `TWD ${Math.round(totalAssetTWD).toLocaleString()}`;
}

function calc(cost, cur) {
    if (cost === 0) return { roi: 0 };
    const roi = (((cur - cost) / cost) * 100).toFixed(1);
    return { roi };
}

function renderAll() {
    renderDashboard();
    // å‘¼å«åŸæœ¬ v16.8 çš„å…¶ä»– render å‡½æ•¸...
}

init();
</script>
</body>
</html>
