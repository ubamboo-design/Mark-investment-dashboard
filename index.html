<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT CAGE : RELOADED v16.2 (Metallic Fix)</title>
<style>
    :root {
        --bg: #0d0d0f; 
        --card: rgba(15, 15, 18, 0.9); 
        --bar-bg: rgba(26, 26, 30, 0.8);
        --text: #e0e0e0; 
        --tw: #ff2a2a; --us: #00d2ff; --gold: #ffd700; 
        --red: #ff2a2a; --green: #00ff6a; --dark-purple: #9400d3; --cyan: #00f7ff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* ğŸ”¥ å¼·æ•ˆé‡‘å±¬èƒŒæ™¯ï¼šé«®çµ²ç´‹ç† + æ°´å¹³éœ“è™¹å…‰æŸç–ŠåŠ  */
    body { 
        background-color: #0a0a0c;
        background-image: 
            /* 1. é«®çµ²ç´‹ (æ©«å‘ç´°å¯†ç´‹ç†) */
            repeating-linear-gradient(
                rgba(255, 255, 255, 0.04) 0px, 
                rgba(255, 255, 255, 0.04) 1px, 
                transparent 1px, 
                transparent 2px
            ),
            /* 2. æ°´å¹³éœ“è™¹æŠ˜å°„ (å°æ‡‰é™„åœ–è³ªæ„Ÿ) */
            linear-gradient(180deg, 
                rgba(0, 247, 255, 0.08) 0%, 
                transparent 15%, 
                rgba(255, 42, 42, 0.08) 30%, 
                transparent 45%,
                rgba(0, 255, 106, 0.07) 60%,
                transparent 75%,
                rgba(255, 215, 0, 0.08) 90%,
                transparent 100%
            ),
            /* 3. é‡‘å±¬å—å…‰æ¼¸å±¤ */
            linear-gradient(90deg, #0d0d0f 0%, #1a1a1e 50%, #0d0d0f 100%);
        background-attachment: fixed;
        background-size: 100% 2px, 100% 100%, 100% 100%;
        color: var(--text); 
        font-family: 'Segoe UI', sans-serif;
    }

    .container { max-width: 1800px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 10; }

    /* DASHBOARD */
    .dashboard-panel { 
        background: linear-gradient(145deg, rgba(30,30,35,0.95), rgba(10,10,12,1)); 
        border: 1px solid #333; border-radius: 10px; padding: 15px; margin: 15px 0 25px 0; 
        box-shadow: 0 15px 40px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.05);
        backdrop-filter: blur(10px);
    }

    /* ARENA BATTLEBARS FIX */
    .arena-dashboard-v15 { display: grid; grid-template-columns: 480px 1fr; gap: 20px; height: 350px; margin-bottom: 30px; }
    .chart-panel { 
        background: rgba(0,0,0,0.6); 
        border: 1px solid #444; border-radius: 10px; 
        position: relative; display: flex; align-items: flex-end; justify-content: space-evenly; 
        padding: 40px 10px 30px 10px; overflow: visible; 
    }
    .chart-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 100% 20%; pointer-events: none; }
    
    /* ğŸ”¥ ä¿®æ­£ï¼šç¢ºä¿ Bar å®¹å™¨å¯è¦‹ä¸”ç½®é ‚ */
    .bar-wrapper { flex: 1; max-width: 50px; display: flex; flex-direction: column; align-items: center; z-index: 20; position: relative; height: 100%; justify-content: flex-end; }
    .bar-fill { 
        width: 85%; border-top: 2px solid #fff; border-radius: 4px 4px 0 0; 
        position: relative; transition: height 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); 
        min-height: 4px; /* é˜²æ­¢ 0% æ™‚å®Œå…¨æ¶ˆå¤± */
    }
    .bar-val-top { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-family: 'Courier New'; font-weight: 900; white-space: nowrap; text-shadow: 0 0 5px #000; }
    .bar-label-bottom { margin-top: 10px; font-size: 0.7rem; color: #aaa; font-family: 'Courier New'; font-weight: bold; }

    /* é…è‰²é¡åˆ¥ */
    .color-profit { color: var(--red)!important; text-shadow: 0 0 8px rgba(255,42,42,0.6); }
    .color-loss { color: var(--green)!important; text-shadow: 0 0 8px rgba(0,255,106,0.6); }
    .color-gold { color: var(--gold)!important; text-shadow: 0 0 15px rgba(255,215,0,0.8); }

    /* å‰©é¤˜çµæ§‹æ¨£å¼ (ç¸®æ¸›ç‰ˆ) */
    .deck-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; }
    .micro-card { background: var(--card); border: 2px solid #333; border-radius: 12px; padding: 12px; transition: 0.3s; min-height: 220px; }
    .mc-media { width: 64px; height: 64px; object-fit: contain; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(10px); }
</style>
</head>
<body>

<div class="container">
  <header style="padding: 20px 0; text-align: center;">
      <h1 id="pageTitle" style="color:#fff; letter-spacing:4px;">PROJECT CAGE</h1>
      <div id="pageMeta" style="color:var(--gold); font-size:0.7rem;">v16.2 METALLIC FIX</div>
  </header>

  <div class="dashboard-panel">
    <div style="display:grid; grid-template-columns: 1fr 1fr 1.3fr; gap:15px;">
      <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
        <div style="color:var(--red); font-weight:900;">TWD æˆ°æƒ…</div>
        <div id="plTW_val" class="color-profit" style="font-size:1.5rem; font-family:'Courier New';">...</div>
        <div id="plTW_pct" class="color-profit">...</div>
      </div>
      <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
        <div style="color:var(--us); font-weight:900;">USD æˆ°æƒ…</div>
        <div id="plUS_val" class="color-profit" style="font-size:1.5rem; font-family:'Courier New';">...</div>
        <div id="plUS_pct" class="color-profit">...</div>
      </div>
      <div style="text-align:right;">
        <div id="totalAsset" style="font-size:2rem; font-family:'Courier New'; font-weight:900;">...</div>
        <div id="totalROI" style="font-weight:900;">...</div>
        <div id="rateInfo" style="color:var(--gold); font-size:0.7rem;">USD/TWD: Loading...</div>
      </div>
    </div>
  </div>

  <div id="arenaContainer"></div>

  <div style="margin: 30px 0 10px; border-left: 4px solid var(--gold); padding-left: 10px; font-weight:900;">II. SKILL CARDS</div>
  <div class="deck-grid" id="cardContainer"></div>
</div>

<div id="cardModal" class="modal-overlay" onclick="this.style.display='none'">
  <div class="modal-content" style="background:#111; padding:40px; border-radius:20px; border:1px solid #444;" onclick="event.stopPropagation()">
    <div id="mCode" style="font-size:3rem; font-weight:900;"></div>
    <div id="mSkill" style="color:var(--gold); margin-bottom:20px;"></div>
    <div id="val2" style="color:#ccc;"></div>
  </div>
</div>

<script>
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuNQc8E7BlYLR5E6WlYHVQ3l_ki95CqcEcpS8sNQESRKcg5yECE-e2bgMvLGU-Vx5HFuWo5OS1GUIT/pub?output=tsv';

let currentRate = 32.5;
let cardsData = {}, portfolios = {}, strategiesData = {};

function calc(cost, cur) {
  if(!cost || isNaN(cost) || isNaN(cur)) return {roi:0, arrow:'-', cls:'', diff: 0, sign: ''};
  const diff = cur - cost;
  const roiRaw = (diff / cost);
  const roi = (roiRaw * 100).toFixed(1);
  let cls = roiRaw >= 0.5 ? 'color-gold' : (roiRaw >= 0 ? 'color-profit' : 'color-loss');
  return { roi, arrow: roi >= 0 ? 'â–²' : 'â–¼', sign: roi >= 0 ? '+' : '', cls, diff };
}

async function init() {
    try {
        const res = await fetch(GOOGLE_SHEET_URL + `&t=${Date.now()}`);
        const text = await res.text();
        parseData(text);
    } catch (e) { console.error("Data Load Error"); }
    renderAll();
}

function parseData(text) {
    const rows = text.split('\n').map(r => r.split('\t'));
    rows.forEach(c => {
        if(c[0].startsWith('C')) {
            let cost = parseFloat((c[5]||'0').replace(/[^\d.]/g,'')) || 0;
            let current = parseFloat((c[6]||'0').replace(/[^\d.]/g,'')) || 0;
            cardsData[c[0]] = { code: c[0], type: c[1], rpg: c[2], target: c[3], skill: c[4], cost, current, strategy: c[7], sop: c[8], imgUrl: c[9] };
        } else if(c[0].startsWith('P')) {
            const p = { code: c[0], name: c[1], deck: (c[2]||'').split('+'), mindset: c[3], persona: c[4], conflict: c[5] };
            if(!portfolios['ALL']) portfolios['ALL'] = [];
            portfolios['ALL'].push(p);
            strategiesData[c[0]] = p;
        }
    });
}

function renderArena() {
    let all = [];
    Object.values(portfolios).flat().forEach(p => {
        let tc=0, ta=0;
        p.deck.forEach(code => { const c = cardsData[code.trim()]; if(c){ tc+=c.cost; ta+=c.current; } });
        const res = calc(tc, ta);
        all.push({...p, ...res, roiNum: parseFloat(res.roi)});
    });

    const sorted = [...all].sort((a,b) => b.roiNum - a.roiNum);
    let html = `<div class="arena-dashboard-v15"><div class="leaderboard-panel" style="background:rgba(0,0,0,0.4);"><div class="lb-header">Leaderboard</div><div class="lb-list">`;
    sorted.forEach((s, i) => {
        html += `<div class="lb-row"><span class="lb-rank">#${i+1}</span><div class="lb-info"><div class="lb-name">${s.name}</div><div class="lb-code">${s.code}</div></div><span class="lb-val ${s.cls}">${s.roi}%</span></div>`;
    });
    html += `</div></div><div class="chart-panel"><div class="chart-grid"></div>`;

    const chartItems = [...all].sort((a,b) => a.code.localeCompare(b.code)).slice(0, 13);
    const maxROI = Math.max(...chartItems.map(x => Math.abs(x.roiNum)), 10);

    chartItems.forEach(s => {
        const h = Math.max((Math.abs(s.roiNum) / maxROI) * 100, 5);
        let barColor = s.cls === 'color-gold' ? 'var(--gold)' : (s.cls === 'color-profit' ? 'var(--red)' : 'var(--green)');
        
        // ğŸ”¥ é—œéµä¿®æ­£ï¼šBar çš„é«˜åº¦æ¸²æŸ“èˆ‡é¡¯ç¤º
        html += `
        <div class="bar-wrapper">
            <div class="bar-fill" style="height:${h}%; background:${barColor}; box-shadow: 0 0 15px ${barColor}aa;">
                <span class="bar-val-top" style="color:${barColor}">${s.roi}%</span>
            </div>
            <div class="bar-label-bottom">${s.code}</div>
        </div>`;
    });
    document.getElementById('arenaContainer').innerHTML = html + `</div></div>`;
}

function renderAll() {
    // ç°¡å–®æ•¸æ“šå¡«å…… (Dashboard é‚è¼¯ç•¥)
    renderArena();
    document.getElementById('cardContainer').innerHTML = Object.values(cardsData).map(c => `
        <div class="micro-card" onclick="openModal('${c.code}')">
            <div style="font-weight:900;">${c.code}</div>
            <div style="text-align:center; flex-grow:1;"><img class="mc-media" src="${c.imgUrl}"></div>
            <div style="text-align:center; font-size:0.9rem;">${c.rpg}</div>
        </div>`).join('');
}

function openModal(k) {
    const c = cardsData[k];
    document.getElementById('mCode').textContent = c.code;
    document.getElementById('mSkill').textContent = c.skill;
    document.getElementById('val2').textContent = c.strategy;
    document.getElementById('cardModal').style.display = 'flex';
}

init();
</script>
</body>
</html>
